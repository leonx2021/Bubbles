import random
import re
from wcferry import Wcf
from typing import Callable, Optional

class InsultGenerator:
    """
    ç”Ÿæˆè´´å§é£æ ¼çš„éª‚äººè¯æœ¯
    """
    
    # è´´å§é£æ ¼éª‚äººè¯æœ¯æ¨¡æ¿
    INSULT_TEMPLATES = [
        "{target}ï¼Œä½ è¿™æƒ³æ³•å±å®æœ‰ç‚¹æŠ½è±¡ï¼Œå»ºè®®å›ç‚‰é‡é€ ã€‚",
        "ä¸æ˜¯å§ï¼Œ{target}ï¼Œè¿™éƒ½èƒ½è¯´å‡ºæ¥ï¼Ÿå¤§è„‘æ˜¯ç”¨æ¥æ€è€ƒçš„ï¼Œä¸æ˜¯ç”¨æ¥é•¿ä¸ªå„¿çš„ã€‚",
        "ä¹ï¼Œ{target} ä½ æˆåŠŸé€—ç¬‘äº†æˆ‘ï¼Œå°±åƒçœ‹çŒ´æˆä¸€æ ·ã€‚",
        "æˆ‘è¯´ {target} å•Šï¼Œç½‘ä¸Šåµæ¶æ²¡èµ¢è¿‡ï¼Œç°å®æ‰“æ¶æ²¡è¾“è¿‡æ˜¯å§ï¼Ÿ",
        "{target}ï¼Œå¬å›ä¸€å¸­è¯ï¼Œæµªè´¹ååˆ†é’Ÿã€‚",
        "ç»™ä½ ä¸ªæ¢¯å­ï¼Œ{target}ï¼Œä¸‹ä¸ªå°é˜¶å§ï¼Œåˆ«æè¿™ä¸¢äººç°çœ¼äº†ã€‚",
        "å°±è¿™ï¼Ÿ{target}ï¼Œå°±è¿™ï¼Ÿæˆ‘è¿˜ä»¥ä¸ºå¤šå¤§äº‹å‘¢ã€‚",
        "{target}ï¼Œä½ æ˜¯ä¸æ˜¯ç½‘çº¿ç›´è¿é©¬æ¡¶çš„ï¼Ÿå‘³å„¿æœ‰ç‚¹å†²ã€‚",
        "è®²é“ç†ï¼Œ{target}ï¼Œä½ è¿™å‘è¨€æ°´å¹³ï¼Œåœ¨è´´å§éƒ½æ´»ä¸è¿‡ä¸‰æ¥¼ã€‚",
        "{target}ï¼Œå»ºè®®ä½ å»ä¹°ä¸¤æ–¤çŒªè„‘å­ç…²æ±¤å–ï¼Œè¡¥è¡¥æ™ºå•†ã€‚",
        "è¯´çœŸçš„ï¼Œ{target}ï¼Œä½ è¿™æ™ºå•†è¦æ˜¯æ”¾åœ¨å¥½å£°éŸ³èƒ½æŠŠé‚£å››æŠŠæ¤…å­éƒ½è½¬å›æ¥ã€‚",
        "{target}ï¼Œæ”¾ç€å¥½ç«¯ç«¯çš„æ™ºå•†ä¸ç”¨ï¼Œéå¾—ç§€ä¸‹é™æ˜¯å§ï¼Ÿ",
        "æˆ‘çœ‹ä½ æ˜¯å…¸å‹çš„è„‘å­æ­é”™å¼¦ï¼Œ{target}ï¼Œè¯´è¯ä¸€å¥—ä¸€å¥—çš„ã€‚",
        "{target}ï¼Œåˆ«æ•´å¤©æè¿™å„¿æ°´ç»éªŒäº†ï¼Œä½ è¿™æ°´å¹³ä¹Ÿå°±é€‚åˆåˆ°å¹¼å„¿å›­é—¨å£å–ç³–æ°´ã€‚",
        "ä½ è¿™å¥è¯æ°´å¹³è·Ÿä½ æ™ºå•†ä¸€æ ·ï¼Œ{target}ï¼Œéƒ½åœ¨åœ°å¹³çº¿ä»¥ä¸‹ã€‚",
        "å°±ä½ è¿™ä¸ªæ°´å¹³ï¼Œ{target}ï¼Œçœ‹ç‹è€…è£è€€çš„è§†é¢‘éƒ½èƒ½è®©ä½ ä¹°é”™è£…å¤‡ã€‚",
        "{target}ï¼Œæ•´å¤©å«å”¤å•¥å‘¢ï¼Ÿæˆ‘æ²¡çœ‹ã€Šè¥¿æ¸¸è®°ã€‹çš„æ—¶å€™çœŸä¸çŸ¥é“çŒ´å­èƒ½è¯´äººè¯ã€‚",
        "æˆ‘å¬æ‡‚äº†ï¼Œ{target}ï¼Œä½ è¯´çš„éƒ½å¯¹ï¼Œå¯æ˜¯èƒ½ä¸èƒ½å…ˆæŠŠè„‘å­è£…å›å»å†è¯´è¯ï¼Ÿ",
        "ç»™{target}é¼“ä¸ªæŒï¼ŒæˆåŠŸæŠŠæˆ‘é€—ä¹äº†ï¼Œè¿™ä¹ˆå¤šå¹´çš„ä¹å­äººï¼Œä»Šå¤©æ˜¯æ ½ä½ æ‰‹é‡Œäº†ã€‚",
        "{target}ï¼Œæˆ‘çœ‹ä½ æ˜¯å­”å­æ”¾å±â€”â€”é—»ï¼ˆæ–‡ï¼‰æ‰€æœªé—»ï¼ˆé—»ï¼‰å•Šã€‚",
        "æ”¶æ•›ç‚¹å§ï¼Œ{target}ï¼Œä½ è¿™æ™ºå•†ä½™é¢æ˜æ˜¾ä¸è¶³äº†ã€‚",
        "{target}ï¼Œä½ è¦æ˜¯æ²¡è¯è¯´å¯ä»¥å’¬ä¸ªæ‰“ç«æœºï¼Œå¤§å®¶çˆ±çœ‹é‚£ä¸ªã€‚",
        "{target}ï¼ŒçŸ¥é“ä½ æ€¥ï¼Œä½†ä½ å…ˆåˆ«æ€¥ï¼Œå–å£æ°´æ…¢æ…¢è¯´ã€‚",
        "{target}ï¼Œä½ è¿™å‘è¨€è·Ÿä½ é•¿ç›¸ä¸€æ ·ï¼Œçªå‡ºä¸€ä¸ªéšå¿ƒæ‰€æ¬²ã€‚",
        "ä¸æ˜¯ï¼Œ{target}ï¼Œä½ è¿™è„‘å›è·¯æ˜¯ç›˜å±±å…¬è·¯å—ï¼Ÿä¹æ›²åå…«å¼¯å•Šï¼Ÿ",
        "{target}ï¼Œå¤ªå¹³æ´‹æ²¡åŠ ç›–ï¼Œè§‰å¾—å§”å±ˆå¯ä»¥è·³ä¸‹å»ã€‚",
        "æè¿™å„¿è£…å•¥å¤§å°¾å·´ç‹¼å‘¢ {target}ï¼Ÿå°¾å·´éƒ½å¿«æ‘‡æ–­äº†å§ï¼Ÿ",
        "{target}ï¼Œæˆ‘çœ‹ä½ ä¸æ˜¯è„‘å­è¿›æ°´ï¼Œæ˜¯è„‘å­è¢«é©´è¸¢äº†å§ï¼Ÿ",
        "ç»™ä½ è„¸äº†æ˜¯å§ {target}ï¼ŸçœŸä»¥ä¸ºè‡ªå·±æ˜¯ä¸ªäººç‰©äº†ï¼Ÿ",
        "{target}ï¼Œå°‘åœ¨è¿™é‡Œç‹ºç‹ºç‹‚å ï¼Œå½±å“å¸‚å®¹ã€‚",
        "ä½ è¿™æ™ºå•†ï¼Œ{target}ï¼ŒäºŒç»´ç æ‰«å‡ºæ¥éƒ½å¾—æ˜¯ä»˜æ¬¾ç ã€‚",
        "ä¹æ­»æˆ‘äº†ï¼Œ{target}ï¼Œå“ªæ¥çš„è‡ªä¿¡åœ¨è¿™é‡ŒæŒ‡ç‚¹æ±Ÿå±±ï¼Ÿ",
        "{target}ï¼Œå›å»å¤šè¯»ä¸¤å¹´ä¹¦å§ï¼Œçœå¾—å‡ºæ¥ä¸¢äººç°çœ¼ã€‚",
        "èµ¶ç´§çˆ¬å§ {target}ï¼Œåˆ«åœ¨è¿™æ±¡æŸ“ç©ºæ°”äº†ã€‚",
        "æˆ‘çœ‹ä½ æ˜¯æ²¡æŒ¨è¿‡æ‰“ï¼Œ{target}ï¼Œè¿™ä¹ˆåš£å¼ ã€‚",
        "ç»™ä½ ä¸ªé”®ç›˜ï¼Œ{target}ï¼Œä½ èƒ½æ•²å‡ºä¸€éƒ¨ã€Šåœ£ç»ã€‹æ¥æ˜¯å§ï¼Ÿ",
        "è„‘å­æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œ{target}ï¼Œå¸Œæœ›ä½ ä¹Ÿæœ‰ä¸€ä¸ªã€‚",
        "{target}ï¼Œå°‘åœ¨è¿™é‡Œç§€ä½ çš„æ™ºå•†ä¸‹é™ã€‚",
        "å°±è¿™ï¼Ÿ{target}ï¼Ÿæˆ‘è¿˜ä»¥ä¸ºå¤šç‰›é€¼å‘¢ï¼ŒåŸæ¥æ˜¯ä¸ªæ†¨æ‰¹ã€‚",
        "{target}ï¼Œä½ è¿™ç†è§£èƒ½åŠ›ï¼Œæ€•ä¸æ˜¯èƒæ•™æ²¡åšå¥½ã€‚",
        "{target}ï¼Œæˆ‘çœ‹ä½ åƒä¸ªå°ä¸‘ï¼Œä¸Šè¹¿ä¸‹è·³çš„ã€‚",
        "ä½ è¿™é€»è¾‘ï¼Œ{target}ï¼Œä½“è‚²è€å¸ˆæ•™çš„å§ï¼Ÿ",
        "ä½ è¿™å‘è¨€ï¼Œ{target}ï¼Œå ªç§°å½“ä»£è¿·æƒ‘è¡Œä¸ºå¤§èµã€‚",
        "{target}ï¼Œä½ è¿™ç‹—å«å£°èƒ½ä¸èƒ½å°ç‚¹ï¼Ÿ",
        "ä½ æ˜¯çŒ´å­è¯·æ¥çš„æ•‘å…µå—ï¼Ÿ{target}ï¼Ÿ",
        "{target}ï¼Œä½ è¿™è„‘å®¹é‡ï¼Œæ€•æ˜¯è¿æ¡è‰å±¥è™«éƒ½ä¸å¦‚ã€‚",
        "ç»™ä½ ä¸ªæ†å­ä½ å°±å¾€ä¸Šçˆ¬æ˜¯å§ï¼Ÿ{target}ï¼Ÿ",
        "{target}ï¼Œä½ è¿™å˜´è·Ÿå¼€äº†å…‰ä¼¼çš„ï¼Œå­å­ä¸ªæ²¡å®Œã€‚",
        "çœçœå§ {target}ï¼Œä½ çš„æ™ºå•†ç¨å·²ç»äº¤å¾—å¤Ÿå¤šäº†ã€‚",
        "{target}ï¼Œä½ è¿™å‘è¨€å¦‚åŒè€å¤ªå¤ªçš„è£¹è„šå¸ƒï¼Œåˆè‡­åˆé•¿ã€‚",
        "{target}ï¼Œæˆ‘çœ‹ä½ æ˜¯çœŸçš„çš®ç—’äº†ã€‚",
        "å°‘åœ¨è¿™é‡Œå¦–è¨€æƒ‘ä¼—ï¼Œ{target}ï¼Œæ»šå›ä½ çš„è€é¼ æ´å»ã€‚",
        "{target}ï¼Œä½ å°±åƒä¸ªè‹è‡ä¸€æ ·ï¼Œå—¡å—¡å—¡çƒ¦æ­»äººã€‚"
    ]
    
    @staticmethod
    def generate_insult(target_name: str) -> str:
        """
        éšæœºç”Ÿæˆä¸€å¥é’ˆå¯¹ç›®æ ‡ç”¨æˆ·çš„éª‚äººè¯æœ¯ï¼ˆè´´å§é£æ ¼ï¼‰
        
        Args:
            target_name (str): è¢«éª‚çš„äººçš„åå­—
            
        Returns:
            str: ç”Ÿæˆçš„éª‚äººè¯­å¥
        """
        if not target_name or target_name.strip() == "":
            target_name = "é‚£ä¸ªè°"  # å…œåº•ï¼Œé˜²æ­¢åå­—ä¸ºç©º
        
        template = random.choice(InsultGenerator.INSULT_TEMPLATES)
        return template.format(target=target_name)


def generate_random_insult(target_name: str) -> str:
    """
    éšæœºç”Ÿæˆä¸€å¥é’ˆå¯¹ç›®æ ‡ç”¨æˆ·çš„éª‚äººè¯æœ¯ï¼ˆè´´å§é£æ ¼ï¼‰
    å‡½æ•°å°è£…ï¼Œæ–¹ä¾¿ç›´æ¥è°ƒç”¨
    
    Args:
        target_name (str): è¢«éª‚çš„äººçš„åå­—
        
    Returns:
        str: ç”Ÿæˆçš„éª‚äººè¯­å¥
    """
    return InsultGenerator.generate_insult(target_name)


def handle_insult_request(
    wcf: Wcf, 
    logger, 
    bot_wxid: str, 
    send_text_func: Callable[[str, str, Optional[str]], None], 
    msg,
    target_mention_name: str
) -> bool:
    """
    å¤„ç†ç¾¤èŠä¸­çš„"éª‚ä¸€ä¸‹"è¯·æ±‚ã€‚

    Args:
        wcf: Wcf å®ä¾‹ã€‚
        logger: æ—¥å¿—è®°å½•å™¨ã€‚
        bot_wxid: æœºå™¨äººè‡ªèº«çš„ wxidã€‚
        send_text_func: å‘é€æ–‡æœ¬æ¶ˆæ¯çš„å‡½æ•° (content, receiver, at_list=None)ã€‚
        msg: åŸå§‹æ¶ˆæ¯å¯¹è±¡ (éœ€è¦ .roomid å±æ€§)ã€‚
        target_mention_name: ä»æ¶ˆæ¯ä¸­æå–çš„è¢«@ç”¨æˆ·çš„åç§°ã€‚

    Returns:
        bool: å¦‚æœå¤„ç†äº†è¯¥è¯·æ±‚ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼‰ï¼Œè¿”å› Trueï¼Œå¦åˆ™è¿”å› Falseã€‚
    """
    logger.info(f"ç¾¤èŠ {msg.roomid} ä¸­å¤„ç†éª‚äººæŒ‡ä»¤ï¼ŒæåŠç›®æ ‡ï¼š{target_mention_name}")

    actual_target_name = target_mention_name
    target_wxid = None
    
    try:
        room_members = wcf.get_chatroom_members(msg.roomid)
        found = False
        for wxid, name in room_members.items():
            if target_mention_name == name:
                target_wxid = wxid
                actual_target_name = name
                found = True
                break
        if not found: 
            for wxid, name in room_members.items():
                if target_mention_name in name and wxid != bot_wxid: 
                    target_wxid = wxid
                    actual_target_name = name
                    logger.info(f"éƒ¨åˆ†åŒ¹é…åˆ°ç”¨æˆ·: {name} ({wxid})")
                    break 
    except Exception as e:
        logger.error(f"æŸ¥æ‰¾ç¾¤æˆå‘˜ä¿¡æ¯æ—¶å‡ºé”™: {e}")

    if target_wxid and target_wxid == bot_wxid:
        send_text_func("ğŸ˜… ä¸è¡Œï¼Œæˆ‘ä¸èƒ½éª‚æˆ‘è‡ªå·±ã€‚", msg.roomid)
        return True

    try:
        insult_text = generate_random_insult(actual_target_name)
        send_text_func(insult_text, msg.roomid)
        logger.info(f"å·²å‘é€éª‚äººæ¶ˆæ¯è‡³ç¾¤ {msg.roomid}ï¼Œç›®æ ‡: {actual_target_name}")
        
    except Exception as e:
         logger.error(f"ç”Ÿæˆæˆ–å‘é€éª‚äººæ¶ˆæ¯æ—¶å‡ºé”™: {e}")
         send_text_func("å‘ƒï¼Œæˆ‘æƒ³éª‚ä½†å‡ºé”™äº†...", msg.roomid)
         
    return True